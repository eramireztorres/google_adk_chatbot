{"id": "348ff98c-f61e-4199-802f-b7efbbc335eb", "code": "from __future__ import annotations\n\nimport logging\nimport os\nimport subprocess\nimport sys\nimport tempfile\nfrom pathlib import Path\nfrom typing import Dict\n\nfrom dotenv import load_dotenv\n\nfrom google.adk.agents import LlmAgent\nfrom google.adk.models.lite_llm import LiteLlm\nfrom google.adk.tools.agent_tool import AgentTool\nfrom google.adk.tools.function_tool import FunctionTool\nfrom google.adk.tools.mcp_tool.mcp_toolset import MCPToolset\nfrom google.adk.tools.mcp_tool.mcp_session_manager import SseConnectionParams\nfrom google.adk.tools.tool_context import ToolContext\n\nload_dotenv()\n\n\ndef _configure_logging() -> None:\n    log_dir = Path(__file__).resolve().parent / \"logs\"\n    log_dir.mkdir(parents=True, exist_ok=True)\n    log_file = log_dir / \"adk.log\"\n    logging.basicConfig(\n        level=logging.INFO,\n        format=\"%(asctime)s - %(levelname)s - %(name)s - %(message)s\",\n        handlers=[\n            logging.FileHandler(log_file, encoding=\"utf-8\"),\n            logging.StreamHandler(),\n        ],\n    )\n\n\n_configure_logging()\n\n\n\n# Validating and resolving configuration\ndef _resolve_llm_model() -> str | LiteLlm:\n    provider = os.getenv(\"ADK_LLM_PROVIDER\", \"openai\").strip().lower()\n    model = os.getenv(\"ADK_LLM_MODEL\", \"gpt-4.1-mini\").strip()\n    if provider == \"openai\":\n        return LiteLlm(model=f\"openai/{model}\")\n    return model\n\ndef _rag_mcp_url() -> str:\n    return os.getenv(\"RAG_MCP_URL\", \"http://127.0.0.1:8000/sse\").strip()\n\nmodel = _resolve_llm_model()\nrag_mcp_url = _rag_mcp_url()\n\n# 1. Define the RAG Agent\nrag_toolset = MCPToolset(\n    connection_params=SseConnectionParams(\n        url=rag_mcp_url,\n        timeout=300,\n    )\n)\n\nfrom google.adk.agents import LoopAgent, LlmAgent\n\n# Wrap the rag_agent in a LoopAgent for retry logic on code check failure\nbase_rag_agent = LlmAgent(\n    name=\"RagAgent\",\n    model=model,\n    instruction=(\n        \"Answer user questions about Google ADK using the MCP RAG tool. \"\n        \"If the question has multiple concepts, split into 2-3 focused subqueries, \"\n        \"call the MCP tool for each, and synthesize a single answer. \"\n        \"If the user asks for code, include a Python code block. \"\n        \"Only use ADK APIs that appear in the provided documentation. \"\n        \"Do not invent convenience methods like agent.chat/agent.run/agent.invoke. \"\n        \"Use the Runner/Invocation patterns shown in ADK docs for execution. \"\n        \"Do not include commented-out calls to non-existent methods; omit the call entirely.\"\n    ),\n    tools=[rag_toolset],\n)\n\nrag_agent = LoopAgent(\n    name=\"RagAgentLoop\",\n    sub_agents=[base_rag_agent],\n    max_iterations=2,\n)\n\n\n# 2. Define the Code Check Tool\ndef run_python_snippet(code: str, tool_context: ToolContext) -> Dict[str, object]:\n    \"\"\"\n    Run a small Python snippet in the current environment to validate imports or\n    simple instantiations. Avoid long-running operations.\n    Escalate early to exit loops if validation fails.\n    \"\"\"\n    if not code or not code.strip():\n        return {\"ok\": False, \"error\": \"No code provided.\"}\n\n    # Limit snippet size to avoid abuse and long runs\n    if len(code) > 1000:\n        return {\"ok\": False, \"error\": \"Code snippet too long.\"}\n\n    with tempfile.NamedTemporaryFile(\"w\", suffix=\".py\", delete=False) as handle:\n        handle.write(code)\n        path = handle.name\n\n    try:\n        result = subprocess.run(\n            [sys.executable, path],\n            capture_output=True,\n            text=True,\n            timeout=10,\n        )\n    except subprocess.TimeoutExpired:\n        return {\"ok\": False, \"error\": \"Execution timed out.\"}\n    finally:\n        try:\n            os.unlink(path)\n        except OSError:\n            pass\n\n    result_payload = {\n        \"ok\": result.returncode == 0,\n        \"returncode\": result.returncode,\n        \"stdout\": result.stdout.strip(),\n        \"stderr\": result.stderr.strip(),\n    }\n    if not result_payload[\"ok\"]:\n        # Escalate to exit LoopAgent early if used in loop\n        tool_context.actions.escalate = True\n    return result_payload\n\n\n# 3. Define the Root Agent\nrag_tool = AgentTool(agent=rag_agent)\ncheck_tool = FunctionTool(func=run_python_snippet)\n\nroot_agent = LlmAgent(\n    name=\"RootAgent\",\n    model=model,\n    instruction=(\n        \"You are the main coordinator agent. For each user query, delegate to the RAG loop agent. \"\n        \"When the RAG agent returns Python code blocks, use the code-check tool to validate imports and instantiations. \"\n        \"If validation fails, instruct the RAG agent to reformulate the answer and retry once. \"\n        \"Only return finalized answers after successful code validation. \"\n        \"Avoid commented-out or non-existent method calls in your responses.\"\n    ),\n    tools=[rag_tool, check_tool],\n)\n\n", "language": "python", "parent_id": "23ab0130-db6e-403b-b44c-0cb21d132c26", "generation": 1, "timestamp": 1769340462.8480473, "iteration_found": 0, "metrics": {"combined_score": 0.5280612759590149, "latency": 43.60539070765177, "artifacts": {"details": [{"query": "Write a complete Python script to create and run a simple ADK agent named 'SimpleAgent' using the 'gpt-4.1-nano' model. The agent should have the instruction 'You are a helpful assistant.' and respond to the user message 'Hello'. Use InMemorySessionService for the session.", "score": 0.45, "latency": 51.867241621017456, "code_extracted": true, "exec_success": false, "keyword_match": 0.16666666666666666}, {"query": "Create a Python script that defines a custom tool function `calculate_area(radius: int) -> dict` which returns the area of a circle. Initialize an ADK Agent with this tool and run it with the query 'Calculate area of circle with radius 5'.", "score": 0.0, "latency": 28.209362506866455, "code_extracted": false, "exec_success": false, "keyword_match": 0.0}, {"query": "Write a Python script to create a SequentialAgent in ADK that chains two sub-agents: `step1_agent` and `step2_agent`. `step1_agent` should generate a topic, and `step2_agent` should write a poem about it. Run the sequential agent.", "score": 0.46, "latency": 74.71838021278381, "code_extracted": true, "exec_success": false, "keyword_match": 0.2}, {"query": "Write a Python script that configures an ADK Agent with a specific `GenerateContentConfig` setting the temperature to 0.7. Run the agent with a simple prompt.", "score": 0.85, "latency": 29.210249662399292, "code_extracted": true, "exec_success": true, "keyword_match": 0.5}, {"query": "Create a Python script that defines a `before_agent_callback` to print 'Agent Starting' before the agent runs. Attach this callback to an ADK Agent and execute it.", "score": 0.82, "latency": 23.710159063339233, "code_extracted": true, "exec_success": true, "keyword_match": 0.4}, {"query": "Write a Python script defining a custom agent class `MyCustomAgent` that inherits from `BaseAgent`. Implement the `_run_async_impl` method to yield a single text event 'Custom Run'. Run an instance of this agent.", "score": 0.85, "latency": 53.916951179504395, "code_extracted": true, "exec_success": true, "keyword_match": 0.5}], "avg_latency": 43.60539070765177}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Change 1: Replace 15 lines with 24 lines\nChange 2: Replace 13 lines with 12 lines\nChange 3: Replace 34 lines with 42 lines", "parent_metrics": {"combined_score": 0.5237877621253332, "latency": 39.54557120800018, "artifacts": {"details": [{"query": "Write a complete Python script to create and run a simple ADK agent named 'SimpleAgent' using the 'gpt-4.1-nano' model. The agent should have the instruction 'You are a helpful assistant.' and respond to the user message 'Hello'. Use InMemorySessionService for the session.", "score": 0.5, "latency": 22.27932381629944, "code_extracted": true, "exec_success": false, "keyword_match": 0.3333333333333333}, {"query": "Create a Python script that defines a custom tool function `calculate_area(radius: int) -> dict` which returns the area of a circle. Initialize an ADK Agent with this tool and run it with the query 'Calculate area of circle with radius 5'.", "score": 0.7, "latency": 33.00701379776001, "code_extracted": true, "exec_success": true, "keyword_match": 0.0}, {"query": "Write a Python script to create a SequentialAgent in ADK that chains two sub-agents: `step1_agent` and `step2_agent`. `step1_agent` should generate a topic, and `step2_agent` should write a poem about it. Run the sequential agent.", "score": 0.46, "latency": 39.699023723602295, "code_extracted": true, "exec_success": false, "keyword_match": 0.2}, {"query": "Write a Python script that configures an ADK Agent with a specific `GenerateContentConfig` setting the temperature to 0.7. Run the agent with a simple prompt.", "score": 0.55, "latency": 15.255670309066772, "code_extracted": true, "exec_success": false, "keyword_match": 0.5}, {"query": "Create a Python script that defines a `before_agent_callback` to print 'Agent Starting' before the agent runs. Attach this callback to an ADK Agent and execute it.", "score": 0.52, "latency": 57.45232081413269, "code_extracted": true, "exec_success": false, "keyword_match": 0.4}, {"query": "Write a Python script defining a custom agent class `MyCustomAgent` that inherits from `BaseAgent`. Implement the `_run_async_impl` method to yield a single text event 'Custom Run'. Run an instance of this agent.", "score": 0.65, "latency": 69.58007478713989, "code_extracted": true, "exec_success": false, "keyword_match": 0.8333333333333334}], "avg_latency": 39.54557120800018}}, "island": 1, "migrant": true}, "prompts": null, "artifacts_json": null, "artifact_dir": null, "embedding": null}